
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Orders - BitCrave</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    .star {
      font-size: 24px;
      cursor: pointer;
      color: #ccc;
      transition: all 0.3s ease;
    }
    .star.selected {
      color: gold;
      transform: scale(1.1);
    }
    
    /* Enhanced Navbar Styles */
    .navbar {
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .navbar-brand {
      transition: all 0.3s ease;
    }
    
    .navbar-brand:hover {
      transform: scale(1.05);
    }
    
    /* Enhanced Button Styles */
    .btn {
      transition: all 0.3s ease;
      border-radius: 8px;
      font-weight: 600;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    /* Enhanced Table Styles */
    .table {
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .table thead th {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      color: white;
      border: none;
      font-weight: 600;
    }
    
    /* Smooth Transitions */
    * {
      transition: all 0.3s ease;
    }

    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body class="bg-light">
  <!-- Enhanced Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark px-4" style="background: linear-gradient(135deg, #1e293b, #0f172a); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
    <a class="navbar-brand" href="#" style="font-size: 1.5rem; font-weight: 700; color: #fbbf24 !important; text-decoration: none;">üçΩÔ∏è BitCrave Staff</a>
    <div class="ms-auto">
      <span class="text-light me-3" id="staffName">Staff Member</span>
      <button class="btn btn-outline-danger" onclick="logoutStaff()" style="border-color: #dc2626; color: #dc2626; font-weight: 600;">Logout</button>
    </div>
  </nav>

  <div class="container mt-5">
    <!-- Stats Section -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="stats-card">
          <h4 id="totalOrders">0</h4>
          <p>Total Orders</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <h4 id="todayOrders">0</h4>
          <p>Today's Orders</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <h4 id="confirmedOrders">0</h4>
          <p>Confirmed</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <h4 id="pendingOrders">0</h4>
          <p>Pending</p>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Confirmed Table Reservations & Orders</h2>
      <div>
        <span class="badge bg-primary" id="orderCount">0 orders</span>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-dark">
              <tr>
                <th>Table No</th>
                <th>Name</th>
                <th>Date</th>
                <th>Time</th>
                <th>Guests</th>
                <th>Pre-Booked Menu</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="staffOrdersTableBody">
              <tr>
                <td colspan="8" class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div class="modal fade" id="editOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-8">
              <h6>Current Order Items:</h6>
              <table class="table table-sm">
                <thead>
                  <tr><th>Item</th><th>Quantity</th><th>Action</th></tr>
                </thead>
                <tbody id="editOrderTableBody"></tbody>
              </table>
            </div>
            <div class="col-md-4">
              <h6>Add New Item:</h6>
              <select id="addMenuItem" class="form-select mb-2">
                <option value="">Select Dish</option>
              </select>
              <button class="btn btn-primary btn-sm" onclick="addMenuItemToOrder()">Add Item</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveOrderChanges()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bill Modal -->
  <div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Generate Bill</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6>Order Details:</h6>
          <ul class="list-group" id="billDetails"></ul>
          <hr>
          <h5>Total: ‚Çπ<span id="totalAmount">0</span></h5>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" onclick="markAsPaid()">Mark as Paid</button>
          <button type="button" class="btn btn-primary" onclick="startRazorpay()">Pay Online</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Submit Feedback</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label>Service Rating:</label>
          <div id="serviceRating"></div>
          <label class="mt-3">Food Rating:</label>
          <div id="foodRating"></div>
          <textarea class="form-control mt-3" id="feedbackMessage" placeholder="Optional message"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-warning" onclick="submitFeedback()">Submit Feedback</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = 'http://localhost:5000/api';
    let reservations = [];
    let menuItems = [];
    let currentEditIndex = null;
    let billIndex = null;
    let feedbackIndex = null;

    // Check authentication on page load
    window.addEventListener('load', () => {
      const staffId = sessionStorage.getItem("current-staff-id");
      const staffName = sessionStorage.getItem("current-staff-name");
      
      if (!staffId || !staffName) {
        alert("‚ùå Please login as staff first!");
        window.location.href = "login.html";
        return;
      }
      
      // Display staff name
      document.getElementById("staffName").textContent = staffName;
      
      // Load data
      loadData();
    });

    // Load all data
    async function loadData() {
      try {
        await Promise.all([
          loadReservations(),
          loadMenuItems(),
          loadStats()
        ]);
      } catch (error) {
        console.error('Error loading data:', error);
        alert('‚ùå Error loading data. Please refresh the page.');
      }
    }

    // Load reservations from API for staff's assigned tables
    async function loadReservations() {
      try {
        const currentStaffId = sessionStorage.getItem("current-staff-id");
        if (!currentStaffId) {
          throw new Error('No staff ID found');
        }

        const response = await fetch(`${API_BASE}/staff/${currentStaffId}/reservations`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        reservations = data.data || [];
        
        updateOrderCount();
        renderStaffOrders();
        
        // Show assigned tables info
        if (data.assignedTables && data.assignedTables.length > 0) {
          const tableInfo = data.assignedTables.join(', ');
          document.getElementById("staffName").textContent = `${sessionStorage.getItem("current-staff-name")} (Tables: ${tableInfo})`;
        } else {
          document.getElementById("staffName").textContent = `${sessionStorage.getItem("current-staff-name")} (No tables assigned)`;
        }
        
      } catch (error) {
        console.error('Error loading reservations:', error);
        document.getElementById("staffOrdersTableBody").innerHTML = `
          <tr>
            <td colspan="8" class="text-center text-danger">
              ‚ùå Error loading orders: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Load menu items from API
    async function loadMenuItems() {
      try {
        const response = await fetch(`${API_BASE}/menu`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        menuItems = data.menu || [];
        
      } catch (error) {
        console.error('Error loading menu items:', error);
      }
    }

    // Load dashboard stats
    async function loadStats() {
      try {
        // For staff, we'll calculate stats from the reservations data we already have
        const confirmedCount = reservations.filter(r => r.status === "Confirmed").length;
        const today = new Date().toISOString().split('T')[0];
        const todayCount = reservations.filter(r => {
          const reservationDate = r.date ? new Date(r.date).toISOString().split('T')[0] : '';
          return reservationDate === today;
        }).length;
        
        const stats = {
          total: reservations.length,
          today: todayCount,
          confirmed: confirmedCount,
          pending: 0 // Staff only sees confirmed reservations
        };
        
        updateStatsCards(stats);
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Update stats cards
    function updateStatsCards(stats) {
      document.getElementById("totalOrders").textContent = stats.total || 0;
      document.getElementById("todayOrders").textContent = stats.today || 0;
      document.getElementById("confirmedOrders").textContent = stats.confirmed || 0;
      document.getElementById("pendingOrders").textContent = stats.pending || 0;
    }

    // Update order count
    function updateOrderCount() {
      // Since staff only sees confirmed reservations, all reservations are confirmed
      document.getElementById("orderCount").textContent = `${reservations.length} orders`;
    }

    async function loadStaffOrders() {
      const tbody = document.getElementById("staffOrdersTableBody");
      tbody.innerHTML = "";
      
      try {
        // All reservations from staff API are already confirmed
        if (reservations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No confirmed orders found.</td></tr>';
          return;
        }
        
        reservations.forEach((r, index) => {
          const row = document.createElement("tr");
          
          // Parse order items
          let orderItems = [];
          if (r.order_items) {
            try {
              // If it's already an object, use it directly
              if (typeof r.order_items === 'object') {
                orderItems = r.order_items;
              } else if (typeof r.order_items === 'string') {
                // If it's a string, try to parse it
                orderItems = JSON.parse(r.order_items);
              }
              
              // Debug: Log the parsed order items
              if (r.id === currentEditIndex) {
                console.log('Rendering reservation', r.id, 'order_items:', r.order_items, 'parsed:', orderItems);
              }
            } catch (e) {
              orderItems = [];
              console.error('Error parsing order_items for reservation', r.id, ':', e);
            }
          }
          
          // Ensure orderItems is an array
          if (!Array.isArray(orderItems)) {
            orderItems = [];
          }
          
          const dateOnly = r.date ? new Date(r.date).toISOString().split('T')[0] : '';
          const statusColor = r.status === "Confirmed" ? "success" : r.status === "Pending" ? "warning" : "danger";
          
          row.innerHTML = `
            <td>${r.table_number || "-"}</td>
            <td>${r.name}</td>
            <td>${dateOnly}</td>
            <td>${r.time}</td>
            <td>${r.people}</td>
            <td>
              <ul class="mb-0">${orderItems.map(i => `<li>${i.name} x ${i.quantity}</li>`).join("") || "<em>No items</em>"}</ul>
            </td>
            <td><span class="badge bg-${statusColor}">${r.status}</span></td>
            <td>
              <button class="btn btn-sm btn-primary mb-1" onclick="editOrder(${r.id})">Edit</button>
              ${r.payment_status !== "Paid" ? `<button class="btn btn-sm btn-success mb-1" onclick="generateBill(${r.id})">Generate Bill</button>` : `<span class="badge bg-success mb-1">‚úÖ Paid</span>`}
              <button class="btn btn-sm btn-warning" onclick="openFeedbackModal(${r.id})" ${r.feedback ? "disabled" : ""}>Feedback</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        
      } catch (error) {
        console.error('Error loading staff orders:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading orders</td></tr>';
      }
    }

    function renderStaffOrders() {
      loadStaffOrders();
    }

    function editOrder(reservationId) {
      currentEditIndex = reservationId;
      const reservation = reservations.find(r => r.id === reservationId);
      if (!reservation) return;

      const tbody = document.getElementById("editOrderTableBody");
      tbody.innerHTML = "";

      let orderItems = [];
      
      // Safely parse order_items
      if (reservation.order_items) {
        try {
          // If it's already an object, use it directly
          if (typeof reservation.order_items === 'object') {
            orderItems = reservation.order_items;
          } else if (typeof reservation.order_items === 'string') {
            // If it's a string, try to parse it
            orderItems = JSON.parse(reservation.order_items);
          }
        } catch (e) {
          console.error('Error parsing order_items:', e);
          orderItems = [];
        }
      }
      
      // Ensure orderItems is an array
      if (!Array.isArray(orderItems)) {
        orderItems = [];
      }

      orderItems.forEach((item, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td><input type="number" min="1" value="${item.quantity}" onchange="updateQty(${i}, this.value)" class="form-control form-control-sm" /></td>
          <td><button class="btn btn-danger btn-sm" onclick="removeItem(${i})">Remove</button></td>`;
        tbody.appendChild(row);
      });

      const dishSelect = document.getElementById("addMenuItem");
      dishSelect.innerHTML = '<option value="">Select Dish</option>' +
        menuItems.map(item => `<option value="${item.name}">${item.name}</option>`).join("");

      new bootstrap.Modal(document.getElementById('editOrderModal')).show();
    }

    function updateQty(index, qty) {
      if (currentEditIndex !== null) {
        const reservation = reservations.find(r => r.id === currentEditIndex);
        if (reservation) {
          let orderItems = [];
          
          // Safely parse order_items
          if (reservation.order_items) {
            try {
              // If it's already an object, use it directly
              if (typeof reservation.order_items === 'object') {
                orderItems = reservation.order_items;
              } else if (typeof reservation.order_items === 'string') {
                // If it's a string, try to parse it
                orderItems = JSON.parse(reservation.order_items);
              }
            } catch (e) {
              console.error('Error parsing order_items:', e);
              orderItems = [];
            }
          }
          
          // Ensure orderItems is an array
          if (!Array.isArray(orderItems)) {
            orderItems = [];
          }
          
          if (orderItems[index]) {
            orderItems[index].quantity = parseInt(qty) || 1;
            reservation.order_items = JSON.stringify(orderItems);
            
            // Update the modal table directly
            const tbody = document.getElementById("editOrderTableBody");
            if (tbody) {
              tbody.innerHTML = "";
              orderItems.forEach((item, i) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${item.name}</td>
                  <td><input type="number" min="1" value="${item.quantity}" onchange="updateQty(${i}, this.value)" class="form-control form-control-sm" /></td>
                  <td><button class="btn btn-danger btn-sm" onclick="removeItem(${i})">Remove</button></td>`;
                tbody.appendChild(row);
              });
            }
            
            // Also update the main table display
            renderStaffOrders();
          }
        }
      }
    }

    function removeItem(index) {
      if (currentEditIndex !== null) {
        const reservation = reservations.find(r => r.id === currentEditIndex);
        if (reservation) {
          let orderItems = [];
          
          // Safely parse order_items
          if (reservation.order_items) {
            try {
              // If it's already an object, use it directly
              if (typeof reservation.order_items === 'object') {
                orderItems = reservation.order_items;
              } else if (typeof reservation.order_items === 'string') {
                // If it's a string, try to parse it
                orderItems = JSON.parse(reservation.order_items);
              }
            } catch (e) {
              console.error('Error parsing order_items:', e);
              orderItems = [];
            }
          }
          
          // Ensure orderItems is an array
          if (!Array.isArray(orderItems)) {
            orderItems = [];
          }
          
          orderItems.splice(index, 1);
          reservation.order_items = JSON.stringify(orderItems);
          
          // Update the modal table directly
          const tbody = document.getElementById("editOrderTableBody");
          if (tbody) {
            tbody.innerHTML = "";
            orderItems.forEach((item, i) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${item.name}</td>
                <td><input type="number" min="1" value="${item.quantity}" onchange="updateQty(${i}, this.value)" class="form-control form-control-sm" /></td>
                <td><button class="btn btn-danger btn-sm" onclick="removeItem(${i})">Remove</button></td>`;
              tbody.appendChild(row);
            });
          }
          
          // Also update the main table display
          renderStaffOrders();
        }
      }
    }

    function addMenuItemToOrder() {
      const selected = document.getElementById("addMenuItem").value;
      if (!selected || currentEditIndex === null) return;

      const reservation = reservations.find(r => r.id === currentEditIndex);
      if (reservation) {
        let orderItems = [];
        
        // Safely parse order_items
        if (reservation.order_items) {
          try {
            // If it's already an object, use it directly
            if (typeof reservation.order_items === 'object') {
              orderItems = reservation.order_items;
            } else if (typeof reservation.order_items === 'string') {
              // If it's a string, try to parse it
              orderItems = JSON.parse(reservation.order_items);
            }
          } catch (e) {
            console.error('Error parsing order_items:', e);
            orderItems = [];
          }
        }
        
        // Ensure orderItems is an array
        if (!Array.isArray(orderItems)) {
          orderItems = [];
        }
        
        const existing = orderItems.find(i => i.name === selected);
        if (existing) {
          existing.quantity += 1;
        } else {
          orderItems.push({ name: selected, quantity: 1 });
        }

        // Update the reservation object in the array
        reservation.order_items = JSON.stringify(orderItems);
        
        // Update the modal table directly
        const tbody = document.getElementById("editOrderTableBody");
        if (tbody) {
          tbody.innerHTML = "";
          orderItems.forEach((item, i) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${item.name}</td>
              <td><input type="number" min="1" value="${item.quantity}" onchange="updateQty(${i}, this.value)" class="form-control form-control-sm" /></td>
              <td><button class="btn btn-danger btn-sm" onclick="removeItem(${i})">Remove</button></td>`;
            tbody.appendChild(row);
          });
        }
        
        // Also update the main table display
        renderStaffOrders();
        
        // Clear the dropdown selection
        document.getElementById("addMenuItem").value = "";
        
        // Debug: Log to confirm the item was added
        console.log('Added item:', selected, 'to reservation:', currentEditIndex);
        console.log('Updated order_items:', reservation.order_items);
      }
    }

    async function saveOrderChanges() {
      if (currentEditIndex === null) return;

      const reservation = reservations.find(r => r.id === currentEditIndex);
      if (!reservation) return;

      try {
        // Ensure order_items is properly formatted as JSON string
        let orderItems = reservation.order_items;
        if (typeof orderItems === 'object') {
          orderItems = JSON.stringify(orderItems);
        } else if (typeof orderItems === 'string') {
          // If it's already a string, make sure it's valid JSON
          try {
            JSON.parse(orderItems);
          } catch (e) {
            orderItems = JSON.stringify([]);
          }
        } else {
          orderItems = JSON.stringify([]);
        }

        const response = await fetch(`${API_BASE}/reservations/${currentEditIndex}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: reservation.name,
            email: reservation.email,
            phone: reservation.phone,
            date: new Date(reservation.date).toISOString().split('T')[0],
            time: reservation.time,
            people: reservation.people,
            message: reservation.message,
            order_items: orderItems
          })
        });

        if (response.ok) {
          alert('‚úÖ Order updated successfully!');
          bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
          
          // Refresh the data from server to ensure consistency
          await loadReservations();
          
          // Also update the stats
          await loadStats();
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.message}`);
        }
      } catch (error) {
        console.error('Error updating order:', error);
        alert('‚ùå Network error. Please try again.');
      }
    }

    function generateBill(reservationId) {
      billIndex = reservationId;
      const reservation = reservations.find(r => r.id === reservationId);
      if (!reservation) return;

      const billList = document.getElementById("billDetails");
      billList.innerHTML = "";

      let total = 0;
      let orderItems = [];
      
      // Safely parse order_items
      if (reservation.order_items) {
        try {
          // If it's already an object, use it directly
          if (typeof reservation.order_items === 'object') {
            orderItems = reservation.order_items;
          } else if (typeof reservation.order_items === 'string') {
            // If it's a string, try to parse it
            orderItems = JSON.parse(reservation.order_items);
          }
        } catch (e) {
          console.error('Error parsing order_items:', e);
          orderItems = [];
        }
      }
      
      // Ensure orderItems is an array
      if (!Array.isArray(orderItems)) {
        orderItems = [];
      }

      orderItems.forEach(item => {
        const price = menuItems.find(m => m.name === item.name)?.price || 100;
        const amount = price * item.quantity;
        total += amount;

        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `${item.name} x ${item.quantity} <span>‚Çπ${amount}</span>`;
        billList.appendChild(li);
      });

      document.getElementById("totalAmount").innerText = total;
      new bootstrap.Modal(document.getElementById('billModal')).show();
    }

    async function markAsPaid() {
      if (billIndex !== null) {
        try {
          const response = await fetch(`${API_BASE}/reservations/${billIndex}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              status: "Confirmed",
              payment_status: "Paid"
            })
          });

          if (response.ok) {
            alert("‚úÖ Payment marked as complete. Table is now free.");
            bootstrap.Modal.getInstance(document.getElementById('billModal')).hide();
            loadReservations();
          } else {
            const error = await response.json();
            alert(`‚ùå Error: ${error.message}`);
          }
        } catch (error) {
          console.error('Error marking as paid:', error);
          alert('‚ùå Network error. Please try again.');
        }
      }
    }

    function startRazorpay() {
      const reservation = reservations.find(r => r.id === billIndex);
      if (!reservation) return;

      const totalAmount = parseFloat(document.getElementById("totalAmount").innerText) || 0;

      const options = {
        key: "rzp_test_Hog4lqhvyUVYdA", // ‚úÖ Your Razorpay test key
        amount: totalAmount * 100,
        currency: "INR",
        name: "BitCrave Restaurant",
        description: `Payment for Table ${reservation.table_number || ''}`,
        handler: function (response) {
          alert("‚úÖ Payment Successful. ID: " + response.razorpay_payment_id);
          markAsPaid();
        },
        prefill: {
          name: reservation.name,
          email: reservation.email,
          contact: reservation.phone
        },
        theme: {
          color: "#3399cc"
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    }

    function openFeedbackModal(reservationId) {
      feedbackIndex = reservationId;
      initStarRating("serviceRating");
      initStarRating("foodRating");
      document.getElementById("feedbackMessage").value = "";
      new bootstrap.Modal(document.getElementById('feedbackModal')).show();
    }

    function initStarRating(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement("span");
        star.classList.add("star");
        star.textContent = "‚òÖ";
        star.onclick = () => setRating(containerId, i);
        container.appendChild(star);
      }
    }

    function setRating(containerId, rating) {
      const stars = document.getElementById(containerId).children;
      for (let i = 0; i < stars.length; i++) {
        stars[i].classList.toggle("selected", i < rating);
      }
      document.getElementById(containerId).dataset.rating = rating;
    }

    async function submitFeedback() {
      if (feedbackIndex === null) return;
      
      const service = document.getElementById("serviceRating").dataset.rating || 0;
      const food = document.getElementById("foodRating").dataset.rating || 0;
      const message = document.getElementById("feedbackMessage").value.trim();

      const feedback = {
        service: parseInt(service),
        food: parseInt(food),
        message: message
      };

      try {
        const response = await fetch(`${API_BASE}/reservations/${feedbackIndex}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            feedback: JSON.stringify(feedback)
          })
        });

        if (response.ok) {
          alert("‚úÖ Feedback submitted successfully.");
          bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
          loadReservations();
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.message}`);
        }
      } catch (error) {
        console.error('Error submitting feedback:', error);
        alert('‚ùå Network error. Please try again.');
      }
    }

    function logoutStaff() {
      sessionStorage.removeItem("current-staff-id");
      sessionStorage.removeItem("current-staff-name");
      window.location.href = "login.html";
    }
  </script>
</body>
</html>
