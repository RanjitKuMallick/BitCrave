<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Menu Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .menu-img-preview {
      width: 60px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
    }
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body onload="checkLogin(); loadMenuItems();">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
    <a class="navbar-brand" href="dashboard.html">‚Üê Dashboard</a>
    <div class="ms-auto d-flex align-items-center gap-2">
      <button class="btn btn-outline-light" id="darkModeToggle">üåô</button>
      <button onclick="logout()" class="btn btn-outline-danger">Logout</button>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>üçΩÔ∏è Menu Management</h3>
      <div class="d-flex gap-3">
        <div class="stats-card">
          <h6 class="mb-0">Total Items</h6>
          <h4 id="totalItems">0</h4>
        </div>
        <div class="stats-card">
          <h6 class="mb-0">Available</h6>
          <h4 id="availableItems">0</h4>
        </div>
      </div>
    </div>

    <!-- Add Item Form -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">‚ûï Add New Menu Item</h5>
      </div>
      <div class="card-body">
        <form id="menuForm" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Item Name</label>
            <input type="text" class="form-control" id="itemName" placeholder="Enter item name" required />
          </div>
          <div class="col-md-2">
            <label class="form-label">Category</label>
            <select class="form-select" id="itemCategory" required>
              <option selected disabled>Select Category</option>
              <option value="Starter">Starter</option>
              <option value="Main Course">Main Course</option>
              <option value="Dessert">Dessert</option>
              <option value="Drinks">Drinks</option>
              <option value="Appetizer">Appetizer</option>
              <option value="Salad">Salad</option>
              <option value="Soup">Soup</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Type</label>
            <select class="form-select" id="itemType" required>
              <option selected disabled>Veg/Non-Veg</option>
              <option value="Veg">Veg</option>
              <option value="Non-Veg">Non-Veg</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Price (‚Çπ)</label>
            <input type="number" class="form-control" id="itemPrice" placeholder="0" min="1" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Image URL</label>
            <input type="url" class="form-control" id="itemImage" placeholder="https://example.com/image.jpg" required />
          </div>
          <div class="col-md-12">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="itemDescription" rows="2" placeholder="Enter item description"></textarea>
          </div>
          <div class="col-md-12">
            <button type="submit" class="btn btn-success" id="submitBtn">
              <span id="submitText">‚ûï Add Item</span>
              <span id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
            <button type="button" class="btn btn-secondary ms-2" onclick="resetForm()">Reset</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Menu Table -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üìã Menu Items</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="exportMenu()">üìä Export</button>
          <button class="btn btn-outline-secondary btn-sm" onclick="loadMenuItems()">üîÑ Refresh</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="menuTable">
            <thead class="table-dark">
              <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Category</th>
                <th>Type</th>
                <th>Price</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="menuBody">
              <tr>
                <td colspan="7" class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Menu Item Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‚úèÔ∏è Edit Menu Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Item Name</label>
                <input type="text" class="form-control" id="editName" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Category</label>
                <select class="form-select" id="editCategory" required>
                  <option value="Starter">Starter</option>
                  <option value="Main Course">Main Course</option>
                  <option value="Dessert">Dessert</option>
                  <option value="Drinks">Drinks</option>
                  <option value="Appetizer">Appetizer</option>
                  <option value="Salad">Salad</option>
                  <option value="Soup">Soup</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Type</label>
                <select class="form-select" id="editType" required>
                  <option value="Veg">Veg</option>
                  <option value="Non-Veg">Non-Veg</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Price (‚Çπ)</label>
                <input type="number" class="form-control" id="editPrice" min="1" required />
              </div>
              <div class="col-md-12">
                <label class="form-label">Image URL</label>
                <input type="url" class="form-control" id="editImage" required />
              </div>
              <div class="col-md-12">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="editDescription" rows="3"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="updateMenuItem()">Update Item</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = 'http://localhost:5000/api';
    const menuForm = document.getElementById("menuForm");
    const menuBody = document.getElementById("menuBody");
    let currentEditingId = null;
    let currentMenuItems = [];

    // Check authentication on page load
    function checkLogin() {
      const token = localStorage.getItem("bitcrave-admin-token");
      if (!token) {
        alert("‚ùå Please login as admin first!");
        window.location.href = "login.html";
        return;
      }
    }

    // Load menu items from API
    async function loadMenuItems() {
      const token = localStorage.getItem("bitcrave-admin-token");
      
      // Show loading
      menuBody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </td>
        </tr>
      `;

      try {
        const response = await fetch(`${API_BASE}/menu`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        currentMenuItems = data.menu || [];
        
        // Update stats
        document.getElementById("totalItems").textContent = currentMenuItems.length;
        document.getElementById("availableItems").textContent = currentMenuItems.filter(item => item.available).length;
        
        // Render table
        renderMenuTable(currentMenuItems);
        
      } catch (error) {
        console.error('Error loading menu items:', error);
        menuBody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-danger">
              ‚ùå Error loading menu items: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Render menu table
    function renderMenuTable(items) {
      menuBody.innerHTML = "";

      if (items.length === 0) {
        menuBody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted">
              üì≠ No menu items found
            </td>
          </tr>
        `;
        return;
      }

      items.forEach((item) => {
        const row = document.createElement("tr");
        
        const statusBadge = item.available 
          ? '<span class="badge bg-success">Available</span>'
          : '<span class="badge bg-danger">Unavailable</span>';
        
        row.innerHTML = `
          <td>
            <img src="${item.image_url || 'https://via.placeholder.com/60x40?text=No+Image'}" 
                 class="menu-img-preview" 
                 onerror="this.src='https://via.placeholder.com/60x40?text=Error'" />
          </td>
          <td><strong>${item.name}</strong></td>
          <td><span class="badge bg-info">${item.category}</span></td>
          <td><span class="badge bg-${item.type === 'Veg' ? 'success' : 'warning'}">${item.type}</span></td>
          <td><strong>‚Çπ${item.price}</strong></td>
          <td>${statusBadge}</td>
          <td>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" onclick="editMenuItem(${item.id})" title="Edit">
                ‚úèÔ∏è
              </button>
              <button class="btn btn-outline-${item.available ? 'warning' : 'success'}" 
                      onclick="toggleAvailability(${item.id})" 
                      title="${item.available ? 'Disable' : 'Enable'}">
                ${item.available ? 'üö´' : '‚úÖ'}
              </button>
              <button class="btn btn-outline-danger" onclick="deleteMenuItem(${item.id})" title="Delete">
                üóëÔ∏è
              </button>
            </div>
          </td>
        `;

        menuBody.appendChild(row);
      });
    }

    // Add new menu item
    menuForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById("submitBtn");
      const submitText = document.getElementById("submitText");
      const submitSpinner = document.getElementById("submitSpinner");
      
      // Show loading state
      submitBtn.classList.add("loading");
      submitText.textContent = "Adding...";
      submitSpinner.classList.remove("d-none");

      const formData = {
        name: document.getElementById("itemName").value.trim(),
        category: document.getElementById("itemCategory").value,
        type: document.getElementById("itemType").value,
        price: parseFloat(document.getElementById("itemPrice").value),
        image_url: document.getElementById("itemImage").value.trim(),
        description: document.getElementById("itemDescription").value.trim()
      };

      const token = localStorage.getItem("bitcrave-admin-token");

      try {
        const response = await fetch(`${API_BASE}/menu`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          alert('‚úÖ Menu item added successfully!');
          menuForm.reset();
          loadMenuItems();
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.message}`);
        }
      } catch (error) {
        console.error('Error adding menu item:', error);
        alert('‚ùå Network error. Please try again.');
      } finally {
        // Reset loading state
        submitBtn.classList.remove("loading");
        submitText.textContent = "‚ûï Add Item";
        submitSpinner.classList.add("d-none");
      }
    });

    // Edit menu item
    async function editMenuItem(id) {
      const item = currentMenuItems.find(item => item.id === id);
      if (!item) return;

      currentEditingId = id;
      
      // Populate form
      document.getElementById("editName").value = item.name;
      document.getElementById("editCategory").value = item.category;
      document.getElementById("editType").value = item.type;
      document.getElementById("editPrice").value = item.price;
      document.getElementById("editImage").value = item.image_url || '';
      document.getElementById("editDescription").value = item.description || '';

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
    }

    // Update menu item
    async function updateMenuItem() {
      if (!currentEditingId) return;

      const token = localStorage.getItem("bitcrave-admin-token");
      const formData = {
        name: document.getElementById("editName").value.trim(),
        category: document.getElementById("editCategory").value,
        type: document.getElementById("editType").value,
        price: parseFloat(document.getElementById("editPrice").value),
        image_url: document.getElementById("editImage").value.trim(),
        description: document.getElementById("editDescription").value.trim()
      };

      try {
        const response = await fetch(`${API_BASE}/menu/${currentEditingId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          alert('‚úÖ Menu item updated successfully!');
          bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
          loadMenuItems();
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.message}`);
        }
      } catch (error) {
        console.error('Error updating menu item:', error);
        alert('‚ùå Network error. Please try again.');
      }
    }

    // Toggle availability
    async function toggleAvailability(id) {
      if (!confirm('üîÑ Toggle availability for this item?')) return;

      const token = localStorage.getItem("bitcrave-admin-token");
      
      try {
        const response = await fetch(`${API_BASE}/menu/${id}/toggle`, {
          method: 'PATCH',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const result = await response.json();
          alert(`‚úÖ Item ${result.available ? 'activated' : 'deactivated'} successfully!`);
          loadMenuItems();
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.message}`);
        }
      } catch (error) {
        console.error('Error toggling availability:', error);
        alert('‚ùå Network error. Please try again.');
      }
    }

    // Delete menu item
    async function deleteMenuItem(id) {
      if (!confirm('üóëÔ∏è Are you sure you want to delete this menu item?')) return;

      const token = localStorage.getItem("bitcrave-admin-token");
      
      try {
        const response = await fetch(`${API_BASE}/menu/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          alert('‚úÖ Menu item deleted successfully!');
          loadMenuItems();
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.message}`);
        }
      } catch (error) {
        console.error('Error deleting menu item:', error);
        alert('‚ùå Network error. Please try again.');
      }
    }

    // Reset form
    function resetForm() {
      menuForm.reset();
    }

    // Export menu
    function exportMenu() {
      const csvContent = "data:text/csv;charset=utf-8," 
        + "ID,Name,Category,Type,Price,Description,Available,Image URL\n"
        + currentMenuItems.map(item => 
          `${item.id},"${item.name}","${item.category}","${item.type}","${item.price}","${item.description || ''}","${item.available}","${item.image_url || ''}"`
        ).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `menu_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Logout function
    async function logout() {
      const token = localStorage.getItem("bitcrave-admin-token");
      
      try {
        if (token) {
          await fetch(`${API_BASE}/admin/logout`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          });
        }
      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        localStorage.removeItem("bitcrave-admin-token");
        localStorage.removeItem("bitcrave-admin-auth");
        localStorage.removeItem("bitcrave-admin-user");
        
        alert("‚úÖ Logged out successfully!");
        window.location.href = "login.html";
      }
    }
  </script>
</body>
</html>
