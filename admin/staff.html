<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€“ Staff Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .staff-card {
      transition: transform 0.2s;
    }
    .staff-card:hover {
      transform: translateY(-2px);
    }
    .table-assignment {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    .assigned-table {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
    }
    .unassigned-table {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold">Staff Management</h2>
      <div>
        <button class="btn btn-outline-primary me-2" onclick="window.location.href='dashboard.html'">Dashboard</button>
        <button class="btn btn-outline-danger btn-sm" onclick="logoutUser()">Logout</button>
      </div>
    </div>

    <div id="alertBox"></div>

    <!-- Add New Staff Form -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Add New Staff</h5>
      </div>
      <div class="card-body">
        <form id="addStaffForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Staff Name</label>
            <input type="text" id="staffName" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Email</label>
            <input type="email" id="staffEmail" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Phone</label>
            <input type="tel" id="staffPhone" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Role</label>
            <select id="staffRole" class="form-select" required>
              <option value="">Select Role</option>
              <option value="waiter">Waiter</option>
              <option value="chef">Chef</option>
              <option value="manager">Manager</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Status</label>
            <select id="staffStatus" class="form-select" required>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Add Staff</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Staff List -->
    <div class="row">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Staff Members</h5>
          </div>
          <div class="card-body">
            <div id="staffList" class="row g-3"></div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Table Assignment</h5>
          </div>
          <div class="card-body">
            <div id="tableAssignmentList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Staff Modal -->
    <div class="modal fade" id="editStaffModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Staff</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editStaffForm">
              <div class="mb-3">
                <label class="form-label">Staff Name</label>
                <input type="text" id="editStaffName" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" id="editStaffEmail" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Phone</label>
                <input type="tel" id="editStaffPhone" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Role</label>
                <select id="editStaffRole" class="form-select" required>
                  <option value="waiter">Waiter</option>
                  <option value="chef">Chef</option>
                  <option value="manager">Manager</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Status</label>
                <select id="editStaffStatus" class="form-select" required>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveStaffEdit()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = 'http://localhost:5000/api';
    let staff = [];
    let reservations = [];
    let currentEditIndex = null;
    let availableTables = [];

    // Check authentication
    function checkAuth() {
      const token = localStorage.getItem("bitcrave-admin-token");
      if (!token) {
        window.location.href = "login.html";
        return false;
      }
      return true;
    }

    function showAlert(message, type) {
      const alertBox = document.getElementById("alertBox");
      alertBox.innerHTML = `<div class='alert alert-${type} alert-dismissible fade show' role='alert'>
        ${message}
        <button type='button' class='btn-close' data-bs-dismiss='alert'></button>
      </div>`;
    }

    async function loadStaff() {
      try {
        const token = localStorage.getItem("bitcrave-admin-token");
        const response = await fetch(`${API_BASE}/staff`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch staff');
        }
        
        const data = await response.json();
        staff = data.data || [];
        
        // Load table assignments for each staff member
        for (let member of staff) {
          try {
            const tableResponse = await fetch(`${API_BASE}/staff/${member.staff_id}/tables`, {
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            
            if (tableResponse.ok) {
              const tableData = await tableResponse.json();
              member.assignedTables = tableData.assignedTables || [];
            }
          } catch (error) {
            console.error(`Error loading tables for staff ${member.staff_id}:`, error);
            member.assignedTables = [];
          }
        }
        
        displayStaff();
      } catch (error) {
        console.error('Error loading staff:', error);
        showAlert('Failed to load staff members', 'danger');
      }
    }

    function displayStaff() {
      const staffList = document.getElementById("staffList");
      staffList.innerHTML = "";

      staff.forEach((member) => {
        const card = document.createElement("div");
        card.className = "col-md-6 col-lg-4";
        card.innerHTML = `
          <div class="card staff-card h-100">
            <div class="card-body">
              <h6 class="card-title">${member.name}</h6>
              <p class="card-text small">
                <i class="fas fa-envelope me-1"></i>${member.email}<br>
                <i class="fas fa-phone me-1"></i>${member.phone}<br>
                <i class="fas fa-user-tag me-1"></i>${member.role}<br>
                <span class="badge bg-${member.status === 'active' ? 'success' : 'secondary'}">${member.status}</span>
                ${member.assignedTables && member.assignedTables.length > 0 ? 
                  `<br><small><i class="fas fa-table me-1"></i>Tables: ${member.assignedTables.map(t => t.table_number).join(', ')}</small>` : 
                  '<br><small><i class="fas fa-table me-1"></i>No tables assigned</small>'
                }
              </p>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="editStaff(${member.id})">Edit</button>
                <button class="btn btn-sm btn-outline-warning" onclick="assignTablesToStaff(${member.staff_id})">Assign Tables</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteStaff(${member.id})">Delete</button>
              </div>
            </div>
          </div>
        `;
        staffList.appendChild(card);
      });
    }

    async function loadAvailableTables() {
      try {
        const token = localStorage.getItem("bitcrave-admin-token");
        const response = await fetch(`${API_BASE}/tables`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch available tables');
        }
        
        const data = await response.json();
        availableTables = data.data || [];
        displayTableAssignments();
      } catch (error) {
        console.error('Error loading available tables:', error);
        showAlert('Failed to load available tables', 'danger');
      }
    }

    function displayTableAssignments() {
      const tableList = document.getElementById("tableAssignmentList");
      tableList.innerHTML = "";

      availableTables.forEach(table => {
        const assignedStaff = staff.find(s => 
          s.assignedTables && s.assignedTables.some(t => t.table_number === table.table_number)
        );
        
        const div = document.createElement("div");
        div.className = `table-assignment ${assignedStaff ? 'assigned-table' : 'unassigned-table'}`;
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <strong>Table ${table.table_number}</strong>
            <span class="badge bg-${assignedStaff ? 'warning' : 'success'}">${assignedStaff ? 'Assigned' : 'Available'}</span>
          </div>
          <div class="mt-2">
            ${assignedStaff ? 
              `<small>Assigned to: ${assignedStaff.name}</small><br>
               <button class="btn btn-sm btn-outline-danger mt-1" onclick="unassignTable('${table.table_number}', ${assignedStaff.staff_id})">Unassign</button>` :
              `<select class="form-select form-select-sm" onchange="assignTable('${table.table_number}', this.value)">
                <option value="">Assign Staff</option>
                ${staff.filter(s => s.status === 'active').map(s => 
                  `<option value="${s.staff_id}">${s.name}</option>`
                ).join('')}
              </select>`
            }
          </div>
        `;
        tableList.appendChild(div);
      });
    }

    async function assignTable(tableNumber, staffId) {
      if (!staffId) return;
      
      try {
        const token = localStorage.getItem("bitcrave-admin-token");
        const selectedStaff = staff.find(s => s.staff_id == staffId);
        
        if (!selectedStaff) {
          showAlert('Staff member not found', 'danger');
          return;
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        const response = await fetch(`${API_BASE}/staff/assign-table`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            staff_id: staffId,
            table_number: tableNumber,
            assigned_date: today
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to assign table');
        }
        
        await loadStaff();
        await loadAvailableTables();
        showAlert(`Table ${tableNumber} assigned to ${selectedStaff.name}`, "success");
      } catch (error) {
        console.error('Error assigning table:', error);
        showAlert(error.message || 'Failed to assign table', 'danger');
      }
    }

    async function unassignTable(tableNumber, staffId) {
      try {
        const token = localStorage.getItem("bitcrave-admin-token");
        const today = new Date().toISOString().split('T')[0];
        
        // Delete the assignment from the database
        const response = await fetch(`${API_BASE}/staff/unassign-table`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            staff_id: staffId,
            table_number: tableNumber,
            assigned_date: today
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to unassign table');
        }
        
        await loadStaff();
        await loadAvailableTables();
        showAlert(`Table ${tableNumber} unassigned`, "info");
      } catch (error) {
        console.error('Error unassigning table:', error);
        showAlert(error.message || 'Failed to unassign table', 'danger');
      }
    }

    async function editStaff(staffId) {
      try {
        const token = localStorage.getItem("bitcrave-admin-token");
        const member = staff.find(s => s.id === staffId);
        
        if (!member) {
          showAlert('Staff member not found', 'danger');
          return;
        }
        
        currentEditIndex = staffId;
        document.getElementById("editStaffName").value = member.name;
        document.getElementById("editStaffEmail").value = member.email;
        document.getElementById("editStaffPhone").value = member.phone;
        document.getElementById("editStaffRole").value = member.role;
        document.getElementById("editStaffStatus").value = member.status;
        
        new bootstrap.Modal(document.getElementById("editStaffModal")).show();
      } catch (error) {
        console.error('Error fetching staff member:', error);
        showAlert('Failed to load staff member details', 'danger');
      }
    }

    async function assignTablesToStaff(staffId) {
      try {
        const member = staff.find(s => s.staff_id === staffId);
        if (!member) {
          showAlert('Staff member not found', 'danger');
          return;
        }

        // Create a modal for table assignment
        const modalHtml = `
          <div class="modal fade" id="assignTablesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Assign Tables to ${member.name}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-md-6">
                      <h6>Available Tables:</h6>
                      <div id="availableTablesList"></div>
                    </div>
                    <div class="col-md-6">
                      <h6>Currently Assigned:</h6>
                      <div id="assignedTablesList"></div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('assignTablesModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Add new modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Populate available tables
        const availableTablesList = document.getElementById('availableTablesList');
        availableTablesList.innerHTML = availableTables
          .filter(table => !member.assignedTables || !member.assignedTables.some(t => t.table_number === table.table_number))
          .map(table => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
              <span>Table ${table.table_number}</span>
              <button class="btn btn-sm btn-primary" onclick="assignTable('${table.table_number}', ${staffId})">Assign</button>
            </div>
          `).join('') || '<p class="text-muted">No available tables</p>';

        // Populate assigned tables
        const assignedTablesList = document.getElementById('assignedTablesList');
        assignedTablesList.innerHTML = (member.assignedTables && member.assignedTables.length > 0) ? 
          member.assignedTables.map(table => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-light">
              <span>Table ${table.table_number}</span>
              <button class="btn btn-sm btn-danger" onclick="unassignTable('${table.table_number}', ${staffId})">Unassign</button>
            </div>
          `).join('') : '<p class="text-muted">No tables assigned</p>';

        // Show modal
        new bootstrap.Modal(document.getElementById('assignTablesModal')).show();

        // Remove modal from DOM after it's hidden
        document.getElementById('assignTablesModal').addEventListener('hidden.bs.modal', function() {
          this.remove();
        });

      } catch (error) {
        console.error('Error opening table assignment modal:', error);
        showAlert('Failed to open table assignment', 'danger');
      }
    }

    async function saveStaffEdit() {
      if (currentEditIndex === null) return;
      
      try {
        const token = localStorage.getItem("bitcrave-admin-token");
        const response = await fetch(`${API_BASE}/staff/${currentEditIndex}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            name: document.getElementById("editStaffName").value,
            email: document.getElementById("editStaffEmail").value,
            phone: document.getElementById("editStaffPhone").value,
            role: document.getElementById("editStaffRole").value,
            status: document.getElementById("editStaffStatus").value
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to update staff member');
        }
        
        await loadStaff();
        bootstrap.Modal.getInstance(document.getElementById("editStaffModal")).hide();
        showAlert("Staff updated successfully", "success");
      } catch (error) {
        console.error('Error updating staff member:', error);
        showAlert('Failed to update staff member', 'danger');
      }
    }

    async function deleteStaff(staffId) {
      if (!confirm("Are you sure you want to delete this staff member?")) return;
      
      try {
        const token = localStorage.getItem("bitcrave-admin-token");
        const response = await fetch(`${API_BASE}/staff/${staffId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to delete staff member');
        }
        
        await loadStaff();
        showAlert("Staff deleted successfully", "warning");
      } catch (error) {
        console.error('Error deleting staff member:', error);
        showAlert('Failed to delete staff member', 'danger');
      }
    }

    function logoutUser() {
      // Get the admin token from sessionStorage or localStorage
      const token = sessionStorage.getItem("bitcrave-admin-token") || localStorage.getItem("bitcrave-admin-token");
      
      if (!token) {
        // If no token, just clear local data and redirect
        sessionStorage.removeItem("bitcrave-admin");
        localStorage.removeItem("bitcrave-admin-token");
        window.location.href = "login.html";
        return;
      }

      fetch("http://localhost:5000/api/admin/logout", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          }
      })
      .then(res => res.json())
      .then(data => {
          console.log("Admin logout response:", data);
          // Clear all stored data
          sessionStorage.removeItem("bitcrave-admin");
          sessionStorage.removeItem("bitcrave-admin-token");
          localStorage.removeItem("bitcrave-admin-token");
          // Redirect to admin login page
          window.location.href = "login.html";
      })
      .catch(err => {
          console.error("Admin logout error:", err);
          // Even if logout fails, clear local data and redirect
          sessionStorage.removeItem("bitcrave-admin");
          sessionStorage.removeItem("bitcrave-admin-token");
          localStorage.removeItem("bitcrave-admin-token");
          window.location.href = "login.html";
      });
    }

    // Add Staff Form Handler
    document.getElementById("addStaffForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      try {
        const token = localStorage.getItem("bitcrave-admin-token");
        const response = await fetch(`${API_BASE}/staff`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            name: document.getElementById("staffName").value,
            email: document.getElementById("staffEmail").value,
            phone: document.getElementById("staffPhone").value,
            role: document.getElementById("staffRole").value,
            status: document.getElementById("staffStatus").value
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to add staff member');
        }
        
        this.reset();
        await loadStaff();
        showAlert("Staff added successfully", "success");
      } catch (error) {
        console.error('Error adding staff member:', error);
        showAlert(error.message || 'Failed to add staff member', 'danger');
      }
    });

    // Load data on page load
    window.onload = async function() {
      if (!checkAuth()) return;
      
      await loadStaff();
      await loadAvailableTables();
    };
  </script>
</body>
</html>
