<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Gallery Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .gallery-item {
      position: relative;
      transition: transform 0.2s;
    }
    .gallery-item:hover {
      transform: scale(1.05);
    }
    .gallery-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
    }
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body onload="checkLogin(); loadGalleryItems();">
  <nav class="navbar navbar-dark bg-dark px-4">
    <a class="navbar-brand" href="dashboard.html">‚Üê Dashboard</a>
    <div class="ms-auto d-flex gap-2">
      <button class="btn btn-outline-light" id="darkModeToggle">üåô</button>
      <button onclick="logout()" class="btn btn-outline-danger">Logout</button>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3>üì∏ Gallery Management</h3>
      <div class="d-flex gap-3">
        <div class="stats-card">
          <h6 class="mb-0">Total Images</h6>
          <h4 id="totalImages">0</h4>
        </div>
      </div>
    </div>

    <!-- Add Image Form -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">‚ûï Add New Gallery Item</h5>
      </div>
      <div class="card-body">
        <form id="galleryForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" id="itemTitle" placeholder="Enter title" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">Image URL</label>
            <input type="url" class="form-control" id="itemImage" placeholder="https://example.com/image.jpg" required />
          </div>
          <div class="col-md-4">
            <label class="form-label">Category</label>
            <select class="form-select" id="itemCategory">
              <option value="">Select Category</option>
              <option value="Food">Food</option>
              <option value="Restaurant">Restaurant</option>
              <option value="Events">Events</option>
              <option value="Ambience">Ambience</option>
              <option value="Chef">Chef</option>
            </select>
          </div>
          <div class="col-md-12">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="itemDescription" rows="3" placeholder="Enter description"></textarea>
          </div>
          <div class="col-md-12">
            <button type="submit" class="btn btn-success" id="submitBtn">
              <span id="submitText">‚ûï Add Image</span>
              <span id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
            <button type="button" class="btn btn-secondary ms-2" onclick="resetForm()">Reset</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Gallery Grid -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üìã Gallery Items</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="exportGallery()">üìä Export</button>
          <button class="btn btn-outline-secondary btn-sm" onclick="loadGalleryItems()">üîÑ Refresh</button>
        </div>
      </div>
      <div class="card-body">
        <div id="galleryGrid" class="row g-4">
          <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Gallery Item Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‚úèÔ∏è Edit Gallery Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Title</label>
                <input type="text" class="form-control" id="editTitle" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Category</label>
                <select class="form-select" id="editCategory">
                  <option value="">Select Category</option>
                  <option value="Food">Food</option>
                  <option value="Restaurant">Restaurant</option>
                  <option value="Events">Events</option>
                  <option value="Ambience">Ambience</option>
                  <option value="Chef">Chef</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label">Image URL</label>
                <input type="url" class="form-control" id="editImage" required />
              </div>
              <div class="col-md-12">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="editDescription" rows="3"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="updateGalleryItem()">Update Item</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = 'http://localhost:5000/api';
    const galleryForm = document.getElementById("galleryForm");
    const galleryGrid = document.getElementById("galleryGrid");
    let currentGalleryItems = [];
    let currentEditingId = null;

    // Check authentication on page load
    function checkLogin() {
      const token = localStorage.getItem("bitcrave-admin-token");
      if (!token) {
        alert("‚ùå Please login as admin first!");
        window.location.href = "login.html";
        return;
      }
    }

    // Load gallery items from API
    async function loadGalleryItems() {
      const token = localStorage.getItem("bitcrave-admin-token");
      
      galleryGrid.innerHTML = `
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `;

      try {
        const response = await fetch(`${API_BASE}/gallery`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        currentGalleryItems = data.gallery || [];
        
        // Update stats
        document.getElementById("totalImages").textContent = currentGalleryItems.length;
        
        // Render gallery
        renderGalleryGrid(currentGalleryItems);
        
      } catch (error) {
        console.error('Error loading gallery items:', error);
        galleryGrid.innerHTML = `
          <div class="col-12 text-center text-danger">
            ‚ùå Error loading gallery items: ${error.message}
          </div>
        `;
      }
    }

    // Render gallery grid
    function renderGalleryGrid(items) {
      galleryGrid.innerHTML = "";

      if (items.length === 0) {
        galleryGrid.innerHTML = `
          <div class="col-12 text-center text-muted">
            üì≠ No gallery items found
          </div>
        `;
        return;
      }

      items.forEach((item) => {
        const col = document.createElement("div");
        col.className = "col-md-4 col-lg-3";
        
        col.innerHTML = `
          <div class="card gallery-item h-100">
            <img src="${item.image_url || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                 class="card-img-top gallery-img" 
                 alt="${item.title}"
                 onerror="this.src='https://via.placeholder.com/300x200?text=Error'" />
            <div class="card-body">
              <h6 class="card-title">${item.title}</h6>
              ${item.category ? `<span class="badge bg-info mb-2">${item.category}</span>` : ''}
              <p class="card-text small">${item.description || 'No description'}</p>
              <div class="btn-group btn-group-sm w-100" role="group">
                <button class="btn btn-outline-primary" onclick="editGalleryItem(${item.id})" title="Edit">
                  ‚úèÔ∏è
                </button>
                <button class="btn btn-outline-danger" onclick="deleteGalleryItem(${item.id})" title="Delete">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        `;

        galleryGrid.appendChild(col);
      });
    }

    // Add new gallery item
    galleryForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById("submitBtn");
      const submitText = document.getElementById("submitText");
      const submitSpinner = document.getElementById("submitSpinner");
      
      // Show loading state
      submitBtn.classList.add("loading");
      submitText.textContent = "Adding...";
      submitSpinner.classList.remove("d-none");

      const formData = {
        title: document.getElementById("itemTitle").value.trim(),
        image_url: document.getElementById("itemImage").value.trim(),
        category: document.getElementById("itemCategory").value,
        description: document.getElementById("itemDescription").value.trim()
      };

      const token = localStorage.getItem("bitcrave-admin-token");

      try {
        const response = await fetch(`${API_BASE}/gallery`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          alert('‚úÖ Gallery item added successfully!');
          galleryForm.reset();
          loadGalleryItems();
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.message}`);
        }
      } catch (error) {
        console.error('Error adding gallery item:', error);
        alert('‚ùå Network error. Please try again.');
      } finally {
        // Reset loading state
        submitBtn.classList.remove("loading");
        submitText.textContent = "‚ûï Add Image";
        submitSpinner.classList.add("d-none");
      }
    });

    // Edit gallery item
    async function editGalleryItem(id) {
      const item = currentGalleryItems.find(item => item.id === id);
      if (!item) return;

      currentEditingId = id;
      
      // Populate form
      document.getElementById("editTitle").value = item.title;
      document.getElementById("editCategory").value = item.category || '';
      document.getElementById("editImage").value = item.image_url || '';
      document.getElementById("editDescription").value = item.description || '';

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
    }

    // Update gallery item
    async function updateGalleryItem() {
      if (!currentEditingId) return;

      const token = localStorage.getItem("bitcrave-admin-token");
      const formData = {
        title: document.getElementById("editTitle").value.trim(),
        category: document.getElementById("editCategory").value,
        image_url: document.getElementById("editImage").value.trim(),
        description: document.getElementById("editDescription").value.trim()
      };

      try {
        const response = await fetch(`${API_BASE}/gallery/${currentEditingId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          alert('‚úÖ Gallery item updated successfully!');
          bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
          loadGalleryItems();
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.message}`);
        }
      } catch (error) {
        console.error('Error updating gallery item:', error);
        alert('‚ùå Network error. Please try again.');
      }
    }

    // Delete gallery item
    async function deleteGalleryItem(id) {
      if (!confirm('üóëÔ∏è Are you sure you want to delete this gallery item?')) return;

      const token = localStorage.getItem("bitcrave-admin-token");
      
      try {
        const response = await fetch(`${API_BASE}/gallery/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          alert('‚úÖ Gallery item deleted successfully!');
          loadGalleryItems();
        } else {
          const error = await response.json();
          alert(`‚ùå Error: ${error.message}`);
        }
      } catch (error) {
        console.error('Error deleting gallery item:', error);
        alert('‚ùå Network error. Please try again.');
      }
    }

    // Reset form
    function resetForm() {
      galleryForm.reset();
    }

    // Export gallery
    function exportGallery() {
      const csvContent = "data:text/csv;charset=utf-8," 
        + "ID,Title,Category,Description,Image URL,Created\n"
        + currentGalleryItems.map(item => 
          `${item.id},"${item.title}","${item.category || ''}","${item.description || ''}","${item.image_url || ''}","${item.created_at}"`
        ).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `gallery_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Logout function
    async function logout() {
      const token = localStorage.getItem("bitcrave-admin-token");
      
      try {
        if (token) {
          await fetch(`${API_BASE}/admin/logout`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          });
        }
      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        localStorage.removeItem("bitcrave-admin-token");
        localStorage.removeItem("bitcrave-admin-auth");
        localStorage.removeItem("bitcrave-admin-user");
        
        alert("‚úÖ Logged out successfully!");
        window.location.href = "login.html";
      }
    }
  </script>
</body>
</html>
        